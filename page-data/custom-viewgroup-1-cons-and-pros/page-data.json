{"componentChunkName":"component---src-templates-blog-post-js","path":"/custom-viewgroup-1-cons-and-pros/","result":{"data":{"site":{"siteMetadata":{"title":"Blog.kt"}},"markdownRemark":{"id":"618511a2-87a9-5d86-bd57-43667df94782","excerpt":"我将在「自定义布局」系列文章介绍我对「自定义布局」的理解、实践经验和个人总结。文章系列可能会有三到四篇，本文是第一篇，介绍一点前置知识。如果您看到本文且对内容有任何意见或建议，都可以随时在网站首页找到方式联系我，我热切期盼能和更多的人交流想法！ 1. 自定义布局的优势 避免读取 XML 的 IO…","html":"<p>我将在「自定义布局」系列文章介绍我对「自定义布局」的理解、实践经验和个人总结。文章系列可能会有三到四篇，本文是第一篇，介绍一点前置知识。如果您看到本文且对内容有任何意见或建议，都可以随时在网站首页找到方式联系我，我热切期盼能和更多的人交流想法！</p>\n<h2>1. 自定义布局的优势</h2>\n<ol>\n<li>避免读取 XML 的 IO 耗时和布局解析（layout inflate）的耗时</li>\n<li>避免 <code class=\"language-text\">findViewById</code> 的耗时</li>\n<li>避免多次测量</li>\n</ol>\n<p>第一、二点我们都好理解，但是第三点就不是很直观了。这里以 LinearLayout 为例，讲一下重复测量的问题。</p>\n<h3>2. 重复测量（和布局）</h3>\n<p>在 LinearLayout 中，当我们给子控件设置了权重 <code class=\"language-text\">android:layout_weight</code> 属性后，子控件将允许按比例分配 LinearLayout 的剩余空间。比如，我们有如下 XML：</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LinearLayout</span> <span class=\"token attr-name\"><span class=\"token namespace\">xmlns:</span>android</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://schemas.android.com/apk/res/android<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">xmlns:</span>tools</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://schemas.android.com/tools<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>match_parent<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>match_parent<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>orientation</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>horizontal<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@+id/ll_root<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\"><span class=\"token namespace\">tools:</span>context</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>.MainActivity<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TextView</span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@+id/tv_1<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>wrap_content<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>wrap_content<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>background</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>#64B5F6<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>singleLine</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>text</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Hello World from Android app.<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TextView</span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@+id/tv_2<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0dp<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>wrap_content<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_weight</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>background</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>#BA68C8<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>singleLine</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\"><span class=\"token namespace\">android:</span>text</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>夫君子之行，静以修身，俭以养德。<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LinearLayout</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"text-align: center; color: #999;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 501px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7de7cea293cbd59dcc4c32ada8bf8b9/55811/pasted-image-20210726181254.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/0lEQVR42pWOQWvCQBSE83dMKASzlKaNREPRGin1Wgg5VageFJFEvBWFll76C1r/ldEeSq+eqiS0FsnuuFkXCtFLH3xvZt5heAqxGjDOa9CLJY6VY3/TTm0UzAoKZ2WByr0qsi2ybtdASi6I5UIxzCpM10c9fEU92OOGU65vwl8Np2h5Lxg0HhA0nxDcPKJ/PeGMMWw+Cw35/dK5hX5RhXJCHPidEd5jIFpRDsOcE0lmXxTLzw3iKEG8+BasuV/PEySLH6xmMX4/tvC8LjRSgaIZDtq9EbJhjGVbgpw/PpRSof5dD2pRFt7LQkoZss5DmOQwp2n6V2gc/fB/k/9wB3NEZtf53SkeAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"custom-viewgroup-sample-0\"\n        title=\"使用 weight 修饰子控件\"\n        src=\"/static/b7de7cea293cbd59dcc4c32ada8bf8b9/55811/pasted-image-20210726181254.png\"\n        srcset=\"/static/b7de7cea293cbd59dcc4c32ada8bf8b9/12f09/pasted-image-20210726181254.png 148w,\n/static/b7de7cea293cbd59dcc4c32ada8bf8b9/e4a3f/pasted-image-20210726181254.png 295w,\n/static/b7de7cea293cbd59dcc4c32ada8bf8b9/55811/pasted-image-20210726181254.png 501w\"\n        sizes=\"(max-width: 501px) 100vw, 501px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">使用 weight 修饰子控件</figcaption>\n  </figure></p>\n<p>就宽度来说：<code class=\"language-text\">tv_2</code> 设置了权重 1，会瓜分所有剩余空间；而 <code class=\"language-text\">tv_1</code> 设置了 <code class=\"language-text\">wrap_content</code>，表示跟随内容。最终效果是，优先保证 <code class=\"language-text\">tv_1</code> 的显示，有剩余空间就全部都分配给 <code class=\"language-text\">tv_2</code>。\n当前（宽度为 <code class=\"language-text\">match_parent</code>）的 <code class=\"language-text\">LinearLayout</code> 的 <code class=\"language-text\">measure</code> 步骤将会如下实现：</p>\n<ol>\n<li>\n<p><a href=\"https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/widget/LinearLayout.java;l=1141-1274;drc=5d123b67756dffcfdebdb936ab2de2b29c799321\">第一次遍历</a> 所有子 View，让他们按照最大可用空间去测量出尺寸</p>\n<ol>\n<li>此时就可以结合父布局（<code class=\"language-text\">ll_root</code>）的宽度（<code class=\"language-text\">match_parent</code>）以及各个子 View 的宽度来计算剩余空间</li>\n</ol>\n</li>\n<li>\n<p><a href=\"https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/widget/LinearLayout.java;l=1351-1424;drc=5d123b67756dffcfdebdb936ab2de2b29c799321\">第二次遍历</a> 会根据子 View 的 <code class=\"language-text\">weight</code> 来分配剩余空间，设置最终的子空间宽度</p>\n</li>\n</ol>\n<p>这里仅描述大致流程，实际上多种情况需要判断：</p>\n<ol>\n<li><code class=\"language-text\">ll_root</code> 本身设置为固定尺寸</li>\n<li>部分子 View 没有 <code class=\"language-text\">weight</code> 的情况</li>\n<li>全部子 View 都有 <code class=\"language-text\">weight</code> 的情况\n…</li>\n</ol>\n<p>所以网上所说的 <code class=\"language-text\">LinearLayout</code> 需要测量两次的意思是指：在子 View 存在 <code class=\"language-text\">layout_weight</code> 属性时，在一次 <code class=\"language-text\">onMeasure</code> 中进行两次遍历调用子 View 测量的现象。而不管是否子控件是否设置 <code class=\"language-text\">android:layout_weight</code> 属性，<code class=\"language-text\">LinearLayout</code> 都只会对子控件执行一次布局操作。</p>\n<p>对于允许创建复杂的「控件约束」的布局来说，重复测量几乎是无法避免的操作。因为设计者希望布局能够尽量覆盖更多实际场景，只要存在约束规则，那么测量流程都会变成：</p>\n<ol>\n<li>确定子控件无限制时的宽度</li>\n<li>根据剩余空间和「控件约束」来重新调整子控件尺寸</li>\n</ol>\n<p>即便是官方推荐的 ConstraintLayout 也是需要两次测量才能实现灵活的约束关系：</p>\n<ol>\n<li>第一遍遍历关系获得约束关系式</li>\n<li>第二遍对约束关系式求值。</li>\n</ol>\n<p>而 FrameLayout 如果有超过一个子控件的尺寸是 <code class=\"language-text\">match_parent</code>，那么也会执行<a href=\"https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/widget/FrameLayout.java;l=229-263;bpv=1;bpt=1?q=FrameLayout\">两次测量</a>。</p>\n<p>归根结底，如果要实现<strong>通用的</strong>、<strong>灵活的</strong>约束布局，至少在目前而言，需要两次测量才能实现。</p>\n<p>自定义布局牺牲了「通用」的特性，甚至是完完全全为了业务写的特定页面，这样可以根据实际需求安排测量逻辑和布局逻辑，仅一次测量就可以完成需求。换句话说，就是用代码方式实现 XML。</p>\n<h3>2.1 嵌套、嵌套还是嵌套</h3>\n<p>其实即便是对子 View 进行两次测量或布局，并不会有太大的影响。问题在于嵌套。我们考虑嵌套三层 <code class=\"language-text\">LinearLayout</code>，那么在最后一层的子控件将有 <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mn>3</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span></span></span></span></span></span></span></span></span> 也就是 8 次的测量。如果被测量的 View 没有对重复测量有所优化，那么将导致明显的性能下降问题。</p>\n<p>所以降低嵌套层次也是提升布局性能一种重要方式。自定义 ViewGroup 可以根据实际需求，降低嵌套的机率。一般如果你能用 ConstraintLayout 实现的低嵌套布局，自定义 ViewGroup 都可以简单地写出来。甚至可以比 ConstraintLayout 的嵌套机率更低。</p>\n<h2>3. 自定义布局的劣势</h2>\n<ol>\n<li>代码不似 XML 一样直观，维护性稍差（但可以通过注释、规范来解决）</li>\n<li>无法兼容所有 XML 属性，比如 <code class=\"language-text\">android:theme</code> 就无法设置，这会影响的主题和控件的复用</li>\n<li>不是所有 XML 属性都存在 API 可供代码设置</li>\n</ol>\n<p>2、3 点几乎无法用其他常规方式实现。3 可以试着用反射的方法修改内部属性，但是依然不是常规方式。这是我们需要承担的成本。在技术调研时，可以考虑 UI 上的控件能否使用自定义的 View 来实现，如果不行，并且该控件具有统一的主题或样式，那么不建议使用自定义 ViewGroup 来实现页面布局。</p>\n<h2>4. 总结</h2>\n<p>本文简单阐述了自定义布局的优劣势以及我对重复测量的理解。算是一些前置知识，方便技术调研或者刚入门的读者快速通览相关内容。下篇文章将开始介绍自定义 ViewGroup 的流程和常用范式。</p>\n<hr>\n<p>REF:</p>\n<ul>\n<li><a href=\"https://developer.android.com/topic/performance/rendering/optimizing-view-hierarchies\">Performance and view hierarchies</a></li>\n<li><a href=\"https://medium.com/@britt.barak/layout-once-layout-twice-sold-aef156ff16a4\">Layout Once, Layout Twice — Sold!</a></li>\n<li><a href=\"https://wiresareobsolete.com/2016/07/constraintlayout-part-2/\">ConstraintLayout, Inside and Out: Part 2</a></li>\n<li><a href=\"https://www.desgard.com/iOS-Source-Probe/Objective-C/UIKit/AutoLayout%20%E4%B8%AD%E7%9A%84%E7%BA%BF%E6%80%A7%E8%A7%84%E5%88%92%20-%20Simplex%20%E7%AE%97%E6%B3%95.html\">AutoLayout 中的线性规划 - Simplex 算法</a></li>\n</ul>","frontmatter":{"title":"自定义布局其一：优劣势与使用场景","date":"2021-08-23","description":null,"excerpt":"我将在「自定义布局」系列文章介绍我对「自定义布局」的理解、实践经验和个人总结。文章系列可能会有三到四篇，本文是第一篇，介绍一点前置知识。"}},"previous":{"fields":{"slug":"intro-sparsearray"},"frontmatter":{"title":"SparseArray 简介"}},"next":{"fields":{"slug":"custom-viewgroup-2-initialization-measure-and-layout"},"frontmatter":{"title":"自定义布局其二：初始化、测量和布局"}}},"pageContext":{"id":"618511a2-87a9-5d86-bd57-43667df94782","previousPostId":"08ed1263-759b-5215-b528-844e800d39bc","nextPostId":"3fc39f7e-e9fa-503e-94e1-3922871fc8ec"}},"staticQueryHashes":["2082311839","2355076697","959449634"],"slicesMap":{}}