{"componentChunkName":"component---src-templates-blog-post-js","path":"/android-get-sd-card-path-and-uuid/","result":{"data":{"site":{"siteMetadata":{"title":"Blog.kt"}},"markdownRemark":{"id":"a179ceb7-2880-59a2-9abc-13ca1cea7792","excerpt":"Android 的存储结构 下面的『内外』，是相对应用而言的。应用内部沙盒称为内部存储，其外部称为外部存储。 内部存储 位置 Android 内部存储在目录下，根据应用的包名划分出来。\n每个应用都有如下几个子文件夹： ：存放该APP内的SP信息 ：存放该APP的数据库信息 ：将APP的文件信息存放在files…","html":"<h1>Android 的存储结构</h1>\n<p>下面的『内外』，是相对应用而言的。应用内部沙盒称为内部存储，其外部称为外部存储。</p>\n<h2>内部存储</h2>\n<h3>位置</h3>\n<p>Android 内部存储在<code class=\"language-text\">/data/data/</code>目录下，根据应用的包名划分出来。\n每个应用都有如下几个子文件夹：</p>\n<ul>\n<li>\n<p><code class=\"language-text\">data/data/包名/shared_prefs</code>：存放该APP内的SP信息</p>\n</li>\n<li>\n<p><code class=\"language-text\">data/data/包名/databases</code>：存放该APP的数据库信息</p>\n</li>\n<li>\n<p><code class=\"language-text\">data/data/包名/files</code>：将APP的文件信息存放在files文件夹</p>\n</li>\n<li>\n<p><code class=\"language-text\">data/data/包名/cache</code>：存放的是APP的缓存信息</p>\n</li>\n</ul>\n<h3>读取方法</h3>\n<p>内部存储不需要申请读取权限，可以任君使用！\n读写文件分别使用：</p>\n<ul>\n<li>\n<p><code class=\"language-text\">openFileOutput()</code></p>\n<ul>\n<li><code class=\"language-text\">write()</code> 写入</li>\n<li><code class=\"language-text\">close()</code> 关闭</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">openFileInput</code></p>\n<ul>\n<li><code class=\"language-text\">read()</code> 读取</li>\n<li><code class=\"language-text\">close()</code>关闭</li>\n</ul>\n</li>\n</ul>\n<p>也可以直接使用：</p>\n<ul>\n<li>\n<p><code class=\"language-text\">getCacheDir()</code>来获取缓存目录</p>\n</li>\n<li>\n<p><code class=\"language-text\">getFilesDir()</code>来获取文件目录</p>\n</li>\n</ul>\n<h2>外部存储</h2>\n<p>外置存储就必须申请权限，而且这里也有一些需要注意的地方，可以移步<a href=\"https://blog.rosuh.me/2018/09/Android-reading-note-12/#Android-8-0-%20%E6%9D%83%E9%99%90%E7%BB%84%20-tips\">阅读</a>。</p>\n<p>一般来说，使用<code class=\"language-text\">Environment.getExternalStorageDirectory()</code>获取的是『外置存储』，但是实际上这个并不是很准确。反而回因为这个『外置』而让人困惑：如果有外置 SD 卡的情况…那谁才是外置呢？</p>\n<p>看一下这个方法的注释，他解释得很清楚：</p>\n<blockquote>\n<p>Note: don’t be confused by the word “external” here. This directory can better be thought as media/shared storage</p>\n</blockquote>\n<p>他说你不要被『外置』这个词搞蒙了，实际上更像是一个『共享』存储器。这样一说其实你就知道了，即便是有外置 SD 卡的情况，两者都属于『外置存储器』。因为这个概念是相对于 App 内部沙盒存储器来说的。\n但是这个时候直接调用这个方法获取的，可能并不是 SD 卡的路径。因为用户并没有将 SD 卡设置为『默认存储器』，所以上面这个方法将会得到原本的『共享』存储器。而不是 SD 卡。</p>\n<p>我们看一下实现：</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">File</span> <span class=\"token function\">getExternalStorageDirectory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">throwIfUserRequired</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> sCurrentUser<span class=\"token punctuation\">.</span><span class=\"token function\">getExternalDirs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">getExternalDirs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">StorageVolume</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> volumes <span class=\"token operator\">=</span> <span class=\"token class-name\">StorageManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">getVolumeList</span><span class=\"token punctuation\">(</span>mUserId<span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">StorageManager</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FLAG_FOR_WRITE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> files <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">[</span>volumes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> volumes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        files<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> volumes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">getPathFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> files<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">getExternalDirs()</code>方法返回了一个分卷列表，然后<code class=\"language-text\">getExternalStorageDirectory()</code>直接返回了该列表的第一个元素。也就是『默认存储器』了。</p>\n<p>那么我们如何获取 SD 卡路径呢？</p>\n<h3>获取外置 SD 卡路径</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">/**\n* 返回外置存储卡路径\n* @param context\n* @return 返回存储卡路径\n*/</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getExtendedMemoryPath</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">StorageManager</span> mStorageManager <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">StorageManager</span><span class=\"token punctuation\">)</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">STORAGE_SERVICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Class</span> storageVolumeClazz<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        storageVolumeClazz <span class=\"token operator\">=</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"android.os.storage.StorageVolume\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Method</span> getVolumeList <span class=\"token operator\">=</span> mStorageManager<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getVolumeList\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Method</span> getPath <span class=\"token operator\">=</span> storageVolumeClazz<span class=\"token punctuation\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getPath\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Method</span> isRemovable <span class=\"token operator\">=</span> storageVolumeClazz<span class=\"token punctuation\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"isRemovable\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Object</span> result <span class=\"token operator\">=</span> getVolumeList<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>mStorageManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLength</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Object</span> storageVolumeElement <span class=\"token operator\">=</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">String</span> path <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> getPath<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>storageVolumeElement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">boolean</span> removable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">)</span> isRemovable<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>storageVolumeElement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>removable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> path<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassNotFoundException</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">InvocationTargetException</span>  <span class=\"token operator\">|</span> <span class=\"token class-name\">NoSuchMethodException</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">IllegalAccessException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里利用了反射获取 SD 卡的路径。</p>\n<h3>获取 SD 卡的 UUID</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">/**\n* 获取 SD 卡的 UUID，FAT32 格式为 xxxx-xxxx；NTFS 是更长的 hex 字符串\n* @param context\n* @return 返回 SD 卡的 UUID\n*/</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getRealSDCardId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">StorageManager</span> mStorageManager <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">StorageManager</span><span class=\"token punctuation\">)</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">STORAGE_SERVICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VERSION</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SDK_INT</span> <span class=\"token operator\">>=</span> <span class=\"token class-name\">Build<span class=\"token punctuation\">.</span>VERSION_CODES<span class=\"token punctuation\">.</span>N</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 如果 API 大于 23，可以直接调用</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mStorageManager <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> mStorageManager<span class=\"token punctuation\">.</span><span class=\"token function\">getStorageVolumes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token class-name\">StorageVolume</span> sdVolume <span class=\"token operator\">=</span> mStorageManager<span class=\"token punctuation\">.</span><span class=\"token function\">getStorageVolumes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> sdVolume<span class=\"token punctuation\">.</span><span class=\"token function\">getUuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> storagePath <span class=\"token operator\">=</span> <span class=\"token function\">getExtendedMemoryPath</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">TextUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>storagePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 只考虑 FAT 32 格式的情况，TODO 兼容 NTFS 格式</span>\n            <span class=\"token class-name\">Pattern</span> pattern <span class=\"token operator\">=</span> <span class=\"token class-name\">Pattern</span><span class=\"token punctuation\">.</span><span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PATTERN_GET_SD_CARD_ID</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Matcher</span> matcher <span class=\"token operator\">=</span> pattern<span class=\"token punctuation\">.</span><span class=\"token function\">matcher</span><span class=\"token punctuation\">(</span>storagePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>matcher<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> matcher<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里还做了版本判断，如果 API 大于 23 的版本，可以直接调用<code class=\"language-text\">getStorageVolumes()</code>方法，获取所有卷的卷标。</p>\n<p><em>参看</em>：</p>\n<ul>\n<li>\n<p><a href=\"https://juejin.im/post/58b557de128fe10065e93cc8\">Android存储（1）— 你还在乱用Android存储嘛！！！</a></p>\n</li>\n<li>\n<p><a href=\"https://stackoverflow.com/questions/47567116/how-to-get-sd-card-id-serial-number?noredirect=1&#x26;lq=1\">How to get SD Card ID/Serial Number?</a></p>\n</li>\n</ul>","frontmatter":{"title":"Android 获取 SD 卡路径和 UUID","date":"2018-09-27","description":"本文将展示 Android 中如何获取 SD 卡的路径，以及 SD 卡的唯一标志 UUID...","excerpt":null}},"previous":{"fields":{"slug":"android-file-type"},"frontmatter":{"title":"如何判断萤石云视频是否可以播放"}},"next":{"fields":{"slug":"/2018-09-27-tika-source-code-analysis/"},"frontmatter":{"title":"Tika 源码浅析"}}},"pageContext":{"id":"a179ceb7-2880-59a2-9abc-13ca1cea7792","previousPostId":"47e589e7-cdf0-5bbe-b03c-db6b5151c44e","nextPostId":"dd6b87bd-85f0-587f-9fc3-fabeee6ddd7c"}},"staticQueryHashes":["2082311839","2355076697","959449634"],"slicesMap":{}}