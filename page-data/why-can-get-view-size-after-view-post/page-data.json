{"componentChunkName":"component---src-templates-blog-post-js","path":"/why-can-get-view-size-after-view-post/","result":{"data":{"site":{"siteMetadata":{"title":"Blog.kt"}},"markdownRemark":{"id":"5920bcd7-07b6-5eb5-97fa-30b55956cf66","excerpt":"å¹¶ä¸æ˜¯ç«‹åˆ»åœ¨   ä¸­è¢«è°ƒç”¨çš„ã€‚å¦‚æœå½“å‰ View è¿˜æ²¡æœ‰ä¾é™„åˆ°ä¸€ä¸ª Window ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆæ¯å°†ä¼šå…ˆä¿å­˜åœ¨ View ä¸­ï¼Œç›´åˆ°æ–¹æ³•è¢«è°ƒç”¨æ—¶æ‰ä¼šæŠŠæ¶ˆæ¯åŠ åˆ° Handler é˜Ÿåˆ—ä¸­ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥æ‹æ¸…è¿™ä¸ªè¿‡ç¨‹ã€‚ View.postDelay() è¿™é‡Œåˆ¤æ–­äº†æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯é‚£ä¹ˆå°†æ¶ˆæ¯å…ˆå­˜æ”¾åˆ° Viewâ€¦","html":"<p><code class=\"language-text\">View.postDelay()</code>å¹¶ä¸æ˜¯ç«‹åˆ»åœ¨ <code class=\"language-text\">Handler</code>  ä¸­è¢«è°ƒç”¨çš„ã€‚å¦‚æœå½“å‰ View è¿˜æ²¡æœ‰ä¾é™„åˆ°ä¸€ä¸ª Window ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆæ¯å°†ä¼šå…ˆä¿å­˜åœ¨ View ä¸­ï¼Œç›´åˆ°<code class=\"language-text\">dispatchAttachToWindow()</code>æ–¹æ³•è¢«è°ƒç”¨æ—¶æ‰ä¼šæŠŠæ¶ˆæ¯åŠ åˆ° Handler é˜Ÿåˆ—ä¸­ã€‚</p>\n<p>ä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥æ‹æ¸…è¿™ä¸ªè¿‡ç¨‹ã€‚</p>\n<h2>View.postDelay()</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> action<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> delayMillis<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">AttachInfo</span> attachInfo <span class=\"token operator\">=</span> mAttachInfo<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>attachInfo <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> attachInfo<span class=\"token punctuation\">.</span>mHandler<span class=\"token punctuation\">.</span><span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">,</span> delayMillis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Postpone the runnable until we know on which thread it needs to run.</span>\n    <span class=\"token comment\">// Assume that the runnable will be successfully placed after attach.</span>\n    <span class=\"token function\">getRunQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">,</span> delayMillis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è¿™é‡Œåˆ¤æ–­äº†<code class=\"language-text\">attachInfo</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯é‚£ä¹ˆå°†æ¶ˆæ¯å…ˆå­˜æ”¾åˆ° View è‡ªå·±çš„å†…éƒ¨å˜é‡<code class=\"language-text\">mRunQueue(HandlerActionQueue)</code> å†…ï¼Œåè€…çš„ç±»å‹ä¸º<code class=\"language-text\">HandlerActionQueue</code>ã€‚</p>\n<p><code class=\"language-text\">HandlerActionQueue</code> è¿™ä¸ªç±»åªæ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åŒ…è£…ç±»ï¼Œå³ä¾¿æ˜¯æ‰§è¡Œæ¶ˆæ¯çš„<code class=\"language-text\">executeActions(Handler handler)</code>æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç”¨å¤–éƒ¨ä¼ å…¥çš„<code class=\"language-text\">handler</code>æ¥æ‰§è¡Œçš„ã€‚æ­¤å¤„å…ˆæŒ‰ä¸‹ä¸è¡¨ã€‚</p>\n<h2>æ‹¿åˆ° AttachInfo çš„æ—¶æœº</h2>\n<p>ä¸ºä»€ä¹ˆè¦æ ¹æ®<code class=\"language-text\">attachInfo</code>æ¥å†³å®šæ˜¯å¦æ‰§è¡Œå‘¢ï¼Ÿå› ä¸ºä¸€ä¸ª<code class=\"language-text\">View</code>å¿…é¡»è¦ä¾é™„åˆ°ä¸€ä¸ª Window ä¸Šï¼Œç”±åè€…é€æ­¥è°ƒç”¨åˆ°ï¼ˆ<code class=\"language-text\">ViewRootImpl</code>ï¼‰æ‰§è¡Œ<code class=\"language-text\">measure</code>,<code class=\"language-text\">layout</code>å’Œ<code class=\"language-text\">onDraw</code>ã€‚è€Œ AttchInfo å°±æ˜¯ç”± Window ä¼ é€’ç»™ View çš„ä¿¡æ¯ã€‚</p>\n<p>è¿™æ˜¯ä»æ„ä¹‰çš„å±‚é¢å»è§£è¯»ï¼Œæˆ‘ä»¬æ¥ç€ä»æºç è§’åº¦çœ‹çœ‹ Android æ˜¯å¦‚ä½•ä¿è¯ <code class=\"language-text\">attchinfo</code> ä¸ä¸ºç©ºåï¼ŒView å°±æœ‰æ„ä¹‰çš„ã€‚</p>\n<p>å½“ç„¶ï¼Œæˆ‘ä»¬æœ€å…ˆçœ‹ View ä¸­çš„<code class=\"language-text\">attachInfo</code>æ˜¯ä½•æ—¶èµ‹å€¼çš„ã€‚</p>\n<p>æ— è®ºæ˜¯ Activity æˆ–è€… Dialogï¼Œä»–ä»¬éƒ½éœ€è¦ Window æ¥æ‰¿è½½ View çš„æ˜¾ç¤ºã€‚æ¯”å¦‚åœ¨ Activity çš„<code class=\"language-text\">setContentView()</code>ä¸­ï¼Œå°±å¦‚ä¸‹ä»£ç ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setContentView</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@LayoutRes</span> <span class=\"token keyword\">int</span> layoutResID<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">getWindow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setContentView</span><span class=\"token punctuation\">(</span>layoutResID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">initWindowDecorActionBar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è¿™é‡Œæ‹¿åˆ° window ç„¶åæŠŠå¸ƒå±€ ID è®¾ç½®è¿›å»ï¼Œè€Œ Activity çš„ window æ˜¯åœ¨ <code class=\"language-text\">attach</code>æ–¹æ³•ä¸­æ‹¿åˆ°çš„ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ActivityThread</span> aThread<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Instrumentation</span> instr<span class=\"token punctuation\">,</span> <span class=\"token class-name\">IBinder</span> token<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> ident<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Application</span> application<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Intent</span> intent<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ActivityInfo</span> info<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">CharSequence</span> title<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Activity</span> parent<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> id<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">NonConfigurationInstances</span> lastNonConfigurationInstances<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Configuration</span> config<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> referrer<span class=\"token punctuation\">,</span> <span class=\"token class-name\">IVoiceInteractor</span> voiceInteractor<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Window</span> window<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ActivityConfigCallback</span> activityConfigCallback<span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">{</span>\n    <span class=\"token function\">attachBaseContext</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    mFragments<span class=\"token punctuation\">.</span><span class=\"token function\">attachHost</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token comment\">/*parent*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    mWindow <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PhoneWindow</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> window<span class=\"token punctuation\">,</span> activityConfigCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mWindow<span class=\"token punctuation\">.</span><span class=\"token function\">setWindowControllerCallback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mWindow<span class=\"token punctuation\">.</span><span class=\"token function\">setCallback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mWindow<span class=\"token punctuation\">.</span><span class=\"token function\">setOnWindowDismissedCallback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mWindow<span class=\"token punctuation\">.</span><span class=\"token function\">getLayoutInflater</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setPrivateFactory</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    mWindow<span class=\"token punctuation\">.</span><span class=\"token function\">setWindowManager</span><span class=\"token punctuation\">(</span>\n                <span class=\"token punctuation\">(</span><span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">)</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WINDOW_SERVICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                mToken<span class=\"token punctuation\">,</span> mComponent<span class=\"token punctuation\">.</span><span class=\"token function\">flattenToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>flags <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">ActivityInfo</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FLAG_HARDWARE_ACCELERATED</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è¿™é‡Œçª—å£å·²ç»è¢«åˆ›å»ºå‡ºæ¥å¹¶ç­‰å¾…ä½¿ç”¨ã€‚</p>\n<p>åœ¨ Activity çš„ <code class=\"language-text\">onResumne()</code> é˜¶æ®µï¼ŒActivity ä¸­çš„ DecorView å’Œ Window ä¸­çš„å±æ€§ä¼šè¢«è®¾ç½®è¿› WindowManagerï¼Œæ­¤æ—¶ DecorView æ‰è¢«è®¾ç½®ä¸ºå¯è§ã€‚</p>\n<p><code class=\"language-text\">ActivityThread::handleResumeActivity()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleResumeActivity</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">IBinder</span> token<span class=\"token punctuation\">,</span> \n    <span class=\"token keyword\">boolean</span> finalStateRequest<span class=\"token punctuation\">,</span> \n    <span class=\"token keyword\">boolean</span> isForward<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">String</span> reason<span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    r<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span>mVisibleFromServer <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    mNumVisibleActivities<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span>mVisibleFromClient<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        r<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span><span class=\"token function\">makeVisible</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Activity::makeVisible()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">void</span> <span class=\"token function\">makeVisible</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mWindowAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//  getWindowManager() å°†ä» Activity çš„ mWindow.getWindowManager() æ‹¿åˆ° WindowManager</span>\n        <span class=\"token comment\">// è€Œåè€…æ˜¯åœ¨ attach ä¸­èµ‹å€¼çš„ï¼Œçœ‹ä¸Šé¢çš„ä»£ç å“¦</span>\n        <span class=\"token class-name\">ViewManager</span> wm <span class=\"token operator\">=</span> <span class=\"token function\">getWindowManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        wm<span class=\"token punctuation\">.</span><span class=\"token function\">addView</span><span class=\"token punctuation\">(</span>mDecor<span class=\"token punctuation\">,</span> <span class=\"token function\">getWindow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mWindowAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    mDecor<span class=\"token punctuation\">.</span><span class=\"token function\">setVisibility</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">View</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VISIBLE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>æ³¨æ„è¿™é‡Œçš„<code class=\"language-text\">wm.addView(mDecor, getWindow().getAttributes());</code>å¾ˆæ˜æ˜¾æ˜¯æŠŠ<code class=\"language-text\">DecorView</code> å’Œ Activity åˆ›å»ºçš„ Window æ·»åŠ åˆ° <code class=\"language-text\">WindowManager</code> ä¸­ã€‚è€Œæ•´ä¸ª<code class=\"language-text\">getWindowManager()</code>è¿”å›çš„è‡ªç„¶å°±æ˜¯<code class=\"language-text\">Activity </code>ä¸­æ–°å»ºçš„<code class=\"language-text\">PhoneWindow</code>å®ä¾‹çš„<code class=\"language-text\">WindowManager</code>ã€‚</p>\n<p>å›é¡¾<code class=\"language-text\">attach</code>ä¸­çš„ä»£ç ï¼Œä½ ä¼šå‘ç°èµ‹å€¼<code class=\"language-text\">WindowManager</code>çš„è¯­å¥ï¼š</p>\n<p><code class=\"language-text\">Activity::attach</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">mWindow<span class=\"token punctuation\">.</span><span class=\"token function\">setWindowManager</span><span class=\"token punctuation\">(</span>\n                <span class=\"token punctuation\">(</span><span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">)</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WINDOW_SERVICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                mToken<span class=\"token punctuation\">,</span> mComponent<span class=\"token punctuation\">.</span><span class=\"token function\">flattenToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>flags <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">ActivityInfo</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FLAG_HARDWARE_ACCELERATED</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ç‚¹è¿›å»çœ‹çœ‹ï¼š</p>\n<p><code class=\"language-text\">Window::setWindwManager</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setWindowManager</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WindowManager</span> wm<span class=\"token punctuation\">,</span> <span class=\"token class-name\">IBinder</span> appToken<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> appName<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">boolean</span> hardwareAccelerated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    mAppToken <span class=\"token operator\">=</span> appToken<span class=\"token punctuation\">;</span>\n    mAppName <span class=\"token operator\">=</span> appName<span class=\"token punctuation\">;</span>\n    mHardwareAccelerated <span class=\"token operator\">=</span> hardwareAccelerated\n            <span class=\"token operator\">||</span> <span class=\"token class-name\">SystemProperties</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBoolean</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROPERTY_HARDWARE_UI</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wm <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        wm <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">)</span>mContext<span class=\"token punctuation\">.</span><span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WINDOW_SERVICE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// é‡ç‚¹çœ‹çœ‹è¿™ä¸ª</span>\n    mWindowManager <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WindowManagerImpl</span><span class=\"token punctuation\">)</span>wm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createLocalWindowManager</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>æœ€åä¸€è¡Œä»£ç ä¸­å°†è¿”å›ä¸€ä¸ª<code class=\"language-text\">WindowManagerImpl</code>ç±»ï¼Œä»–æ˜¯<code class=\"language-text\">WindowManager</code>çš„å®ç°ç±»ã€‚</p>\n<p>åˆ°äº†æ­¤å¤„ï¼Œæˆ‘ä»¬å†çœ‹çœ‹ä¹‹å‰é‚£å¥ï¼š</p>\n<p><code class=\"language-text\">Activity::makeVisiable</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">wm<span class=\"token punctuation\">.</span><span class=\"token function\">addView</span><span class=\"token punctuation\">(</span>mDecor<span class=\"token punctuation\">,</span> <span class=\"token function\">getWindow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>è¿™é‡Œçš„<code class=\"language-text\">wm</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ª<code class=\"language-text\">WindowManagerImpl</code>å®ä¾‹ï¼Œæ¥ç€è°ƒç”¨çš„<code class=\"language-text\">addView()</code>æ–¹æ³•æ˜¯<code class=\"language-text\">WindowManagerImpl</code>å†…éƒ¨çš„ä¸€ä¸ª<code class=\"language-text\">mGlobal</code>ï¼ˆ<code class=\"language-text\">WindowManagerGlobal</code>ï¼‰å»æ‰§è¡Œçš„ã€‚è‡³äº<code class=\"language-text\">WindowManagerGlobal</code>å…·ä½“æ˜¯ä¸ªå•¥ï¼Œæˆ‘ä»¬å…ˆæŒ‰ä¸‹ä¸è¡¨ã€‚</p>\n<p>æˆ‘ä»¬è¿½è¸ªåˆ°è¿™é‡Œçš„åŸå› ï¼Œåªæ˜¯æ‰¾åˆ°æœ€ç»ˆå®ç°<code class=\"language-text\">addView</code>çš„é‚£ä¸ªç±»ï¼Œç„¶åå†æ¥çœ‹çœ‹è¿™ä¸ªç±»é‡Œæœ‰åšå“ªäº›æœ‰æ„æ€çš„äº‹æƒ…ï¼š</p>\n<p><code class=\"language-text\">WindowManagerGlobal::addView()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// ä¼ è¿›æ¥çš„è¿™ä¸ª View å°±æ˜¯ Activity ä¼ è¿‡æ¥çš„ decorView </span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addView</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">View</span> view<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ViewGroup<span class=\"token punctuation\">.</span>LayoutParams</span> params<span class=\"token punctuation\">,</span><span class=\"token class-name\">Display</span> display<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Window</span> parentWindow<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token comment\">// æ–°å»ºä¸€ä¸ª ViewRootImpl å®ä¾‹ </span>\n\troot <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ViewRootImpl</span><span class=\"token punctuation\">(</span>view<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> display<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tview<span class=\"token punctuation\">.</span><span class=\"token function\">setLayoutParams</span><span class=\"token punctuation\">(</span>wparams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mViews<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>view<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tmRoots<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mParams<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>wparams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    \n    <span class=\"token comment\">// do this last because it fires off messages to start doing things</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// æŠŠ View è®¾ç½®ç»™ ViewRootImpl</span>\n        <span class=\"token comment\">// æ‰§è¡Œè¿™ä¸€æ­¥ä¹‹åæ‰çœŸæ­£å¼€å§‹ View å±‚æ“ä½œ</span>\n        root<span class=\"token punctuation\">.</span><span class=\"token function\">setView</span><span class=\"token punctuation\">(</span>view<span class=\"token punctuation\">,</span> wparams<span class=\"token punctuation\">,</span> panelParentView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// BadTokenException or InvalidDisplayException, clean up.</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">removeViewLocked</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>   \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>æ¥ç€å½“ç„¶æ˜¯çœ‹çœ‹<code class=\"language-text\">setView</code>åšäº†ä»€ä¹ˆäº†ï¼š</p>\n<p><code class=\"language-text\">ViewRootImpl::setView\t</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setView</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">View</span> view<span class=\"token punctuation\">,</span> <span class=\"token class-name\">WindowManager<span class=\"token punctuation\">.</span>LayoutParams</span> attrs<span class=\"token punctuation\">,</span> <span class=\"token class-name\">View</span> panelParentView<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token comment\">// Schedule the first layout -before- adding to the window</span>\n    <span class=\"token comment\">// manager, to make sure we do the relayout before receiving</span>\n    <span class=\"token comment\">// any other events from the system.</span>\n    <span class=\"token function\">requestLayout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">requestLayout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mHandlingLayoutInLayoutRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">checkThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mLayoutRequested <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">scheduleTraversals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">scheduleTraversals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mTraversalScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// éå†æ ‡å¿—ä½å€¼ä¸º true</span>\n        mTraversalScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        mTraversalBarrier <span class=\"token operator\">=</span> mHandler<span class=\"token punctuation\">.</span><span class=\"token function\">getLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">postSyncBarrier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mChoreographer<span class=\"token punctuation\">.</span><span class=\"token function\">postCallback</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">Choreographer</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CALLBACK_TRAVERSAL</span><span class=\"token punctuation\">,</span> mTraversalRunnable<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mUnbufferedInputDispatch<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">scheduleConsumeBatchedInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">notifyRendererOfFramePending</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">pokeDrawLockIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>æ²¡æƒ³åˆ°å§â€¦è¿™é‡Œç«Ÿç„¶å…ˆè°ƒç”¨äº†<code class=\"language-text\">requestLayout()</code>æ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æ˜¯åšå•¥çš„å‘¢ï¼Ÿä½ è·Ÿç€ç»§ç»­çœ‹ï¼Œå°±å¯ä»¥åœ¨<code class=\"language-text\">scheduleTraversals()</code>æ–¹æ³•ä¸­çœ‹åˆ°ä¸€ä¸ª<code class=\"language-text\">mTraversalScheduled</code>è¢«ç½®ä¸ºäº†<code class=\"language-text\">true</code>ã€‚è€Œè¿™ä¸ªæ ‡å¿—ä½è¢«<code class=\"language-text\">doTraversal()</code>æ–¹æ³•ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œéå†ã€‚ç»ˆäºåˆ°äº†è¿™ä¸ªé‡è¦çš„æ–¹æ³•äº†ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">\t<span class=\"token class-name\">ViewRootImpl</span><span class=\"token operator\">::</span><span class=\"token function\">doTraversal</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">doTraversal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mTraversalScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mTraversalScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        mHandler<span class=\"token punctuation\">.</span><span class=\"token function\">getLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeSyncBarrier</span><span class=\"token punctuation\">(</span>mTraversalBarrier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mProfile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Debug</span><span class=\"token punctuation\">.</span><span class=\"token function\">startMethodTracing</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ViewAncestor\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\t\t<span class=\"token comment\">// æ‰§è¡Œéå†</span>\n        <span class=\"token function\">performTraversals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mProfile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Debug</span><span class=\"token punctuation\">.</span><span class=\"token function\">stopMethodTracing</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mProfile <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token class-name\">ViewRootImpl</span><span class=\"token operator\">::</span><span class=\"token function\">performTraversals</span>\n<span class=\"token comment\">// ä»£ç å¾ˆé•¿ï¼Œæˆ‘æ‘˜å‡ å¥ä¸»é¢˜ç›¸å…³çš„æ‹¿å‡ºæ¥</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">performTraversals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token comment\">// è¿™ä¸ª mView å°±æ˜¯ setView é‡Œé¢é‚£ä¸ª DecorView    </span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">View</span> host <span class=\"token operator\">=</span> mView<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token comment\">// â‘ </span>\n    <span class=\"token comment\">// å¼€å§‹åˆ†å‘ AttachToWindow æ¶ˆæ¯ï¼Œæ­¤æ—¶å°†ä¼šèµ°  View.dispatchAttachedToWindow() </span>\n    <span class=\"token comment\">// è¿™æ—¶å€™ View.onAttachedToWindow() å°†ä¼šè¢«è°ƒç”¨</span>\n    host<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchAttachedToWindow</span><span class=\"token punctuation\">(</span>mAttachInfo<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token comment\">// Execute enqueued actions on every traversal in case a detached view enqueued an action</span>\n    <span class=\"token comment\">// è¿™å¥æ˜¯æ‰§è¡Œ ViewRootImpl è‡ªå·±çš„æ¶ˆæ¯ï¼Œä¸æ˜¯ host çš„æ¶ˆæ¯    </span>\n    <span class=\"token function\">getRunQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeActions</span><span class=\"token punctuation\">(</span>mAttachInfo<span class=\"token punctuation\">.</span>mHandler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mStopped <span class=\"token operator\">||</span> mReportNextDraw<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    \t<span class=\"token comment\">// â‘¡</span>\n    \t<span class=\"token comment\">// æ‰§è¡Œ Measure</span>\n    \t<span class=\"token function\">performMeasure</span><span class=\"token punctuation\">(</span>childWidthMeasureSpec<span class=\"token punctuation\">,</span> childHeightMeasureSpec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>didLayout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// æ‰§è¡Œ Layout</span>\n        <span class=\"token function\">performLayout</span><span class=\"token punctuation\">(</span>lp<span class=\"token punctuation\">,</span> mWidth<span class=\"token punctuation\">,</span> mHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n     <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n     <span class=\"token comment\">// æ‰§è¡Œ Draw</span>\n     <span class=\"token function\">performDraw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">View</span><span class=\"token operator\">::</span><span class=\"token function\">dispatchAttachedToWindow</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">dispatchAttachedToWindow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AttachInfo</span> info<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> visibility<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t<span class=\"token comment\">// â‘¢</span>\n\t<span class=\"token comment\">// ä½¿ç”¨ View.postDelay çš„æ¶ˆæ¯å°†åœ¨æ­¤è¢«å‘é€åˆ° handler ä¸­</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mRunQueue <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mRunQueue<span class=\"token punctuation\">.</span><span class=\"token function\">executeActions</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>mHandler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mRunQueue <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// è°ƒç”¨ onAttachedToWindow() å›è°ƒ</span>\n    <span class=\"token function\">performCollectViewAttributes</span><span class=\"token punctuation\">(</span>mAttachInfo<span class=\"token punctuation\">,</span> visibility<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">onAttachedToWindow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>æˆ–è®¸åˆ°æ­¤ä½ å¯èƒ½æœ‰ç–‘é—®ï¼Œæ˜æ˜å…ˆæ‰§è¡Œçš„ â‘  å¤„çš„ä»£ç ï¼ŒæŒ‰ç…§æ‰§è¡Œé¡ºåºï¼Œâ‘¢ å¤„çš„ä¼šæ¥ç€æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ<code class=\"language-text\">View.postDely</code> ä¸­çš„ <code class=\"language-text\">Runnable</code> ï¼›æœ€åæ‰æ˜¯ <code class=\"language-text\">Measure</code> ã€<code class=\"language-text\">Layout</code> å’Œ<code class=\"language-text\">Draw</code>ã€‚æ„å‘³ç€<code class=\"language-text\">View.postDelay</code>å¹¶ä¸ä¸€å®šèƒ½åˆ°å®½é«˜ã€‚éš¾é“è¿™æ˜¯é¢å‘è¿æ°”ç¼–ç¨‹ï¼Ÿ</p>\n<p>è‚¯å®šä¸æ˜¯å•ŠğŸ˜‚â€¦ä½ æ³¨æ„çœ‹<code class=\"language-text\">dispatchAttachedToWindow</code>é‡Œçš„æ‰§è¡Œæ˜¯<code class=\"language-text\">mRunQueue.executeActions(info.mHandler);</code>ï¼š</p>\n<p><code class=\"language-text\">HandlerActionQueue::executeActions()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">executeActions</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Handler</span> handler<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">HandlerAction</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> actions <span class=\"token operator\">=</span> mActions<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> count <span class=\"token operator\">=</span> mCount<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> count<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">final</span> <span class=\"token class-name\">HandlerAction</span> handlerAction <span class=\"token operator\">=</span> actions<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// è¿˜æ˜¯åœ¨ handler ä¸Šå‘é€æ¶ˆæ¯</span>\n            handler<span class=\"token punctuation\">.</span><span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span>handlerAction<span class=\"token punctuation\">.</span>action<span class=\"token punctuation\">,</span> handlerAction<span class=\"token punctuation\">.</span>delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        mActions <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        mCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è¿™ä¸ª <code class=\"language-text\">handler</code> æ˜¯ä¸»çº¿ç¨‹çš„<code class=\"language-text\">handler</code>ï¼Œè€Œä¸»çº¿ç¨‹éƒ½æ²¡æœ‰æŠŠ<code class=\"language-text\">performTraversals</code>æ‰§è¡Œå®Œï¼Œå“ªèƒ½è½®åˆ°ä½ åˆšåŠ è¿›æ¥çš„<code class=\"language-text\">View.postDelay</code>çš„æ¶ˆæ¯å‘¢â€¦ä¹–ä¹–æ’é˜Ÿå»å§ã€‚</p>\n<p>æ‰€ä»¥è¿™é‡Œå…¶å®ç”¨åˆ°äº†å¼‚æ­¥æ“ä½œï¼Œåˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯äº†<code class=\"language-text\">Measure</code>ã€<code class=\"language-text\">Layout</code>å’Œ<code class=\"language-text\">Draw</code>æ€»åœ¨<code class=\"language-text\">dispatchAttachedToWindow()</code>åé¢æ‰§è¡Œã€‚è€Œ<code class=\"language-text\">attachInfo</code>æ²¡æœ‰æ‹¿åˆ°çš„è¯ï¼Œ<code class=\"language-text\">View.postDelay</code>åˆæ˜¯ä¸ä¼šæ‰§è¡Œçš„ã€‚</p>\n<p><code class=\"language-text\">View::postDelay</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> action<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> delayMillis<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">AttachInfo</span> attachInfo <span class=\"token operator\">=</span> mAttachInfo<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>attachInfo <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> attachInfo<span class=\"token punctuation\">.</span>mHandler<span class=\"token punctuation\">.</span><span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">,</span> delayMillis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Postpone the runnable until we know on which thread it needs to run.</span>\n    <span class=\"token comment\">// Assume that the runnable will be successfully placed after attach.</span>\n    <span class=\"token function\">getRunQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">,</span> delayMillis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"ä¸ºä»€ä¹ˆä½¿ç”¨ View.postDelay() å°±å¯ä»¥æ‹¿åˆ°å®½é«˜ï¼Ÿ","date":"2019-11-27","description":"æœ¬ç³»åˆ—æ˜¯ç¬”è€…åœ¨å®è·µè¿‡ç¨‹ä¸­å­¦ä¹ æˆ–å¤ä¹ åˆ°çš„ä¸€äº› tipsï¼Œä¸ºäº†é¿å…å¿˜è®°ï¼Œç‰¹åœ°è®°ä¸‹æ¥","excerpt":null}},"previous":{"fields":{"slug":"Manifesto-for-Minimalist-Software-Engineers-CN"},"frontmatter":{"title":"ã€ç¿»è¯‘ã€‘æç®€ä¸»ä¹‰å·¥ç¨‹å¸ˆå®£è¨€"}},"next":{"fields":{"slug":"2019-12-reading-report"},"frontmatter":{"title":"2019-12 è¯»ä¹¦æœˆæŠ¥"}}},"pageContext":{"id":"5920bcd7-07b6-5eb5-97fa-30b55956cf66","previousPostId":"0d7d276c-d513-5bb3-a22a-011b4416a739","nextPostId":"28351538-2ad5-5cba-8765-e7691c65c989"}},"staticQueryHashes":["2082311839","2355076697","959449634"],"slicesMap":{}}